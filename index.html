<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>LARP Beacon</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{--bg:#0b0e12;--panel:#11151b;--rim:#1d2530;--accent:#c33;--text:#e5e7eb;--muted:#9aa3af;}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #top{display:none;padding:8px;gap:8px;align-items:center;background:#0f141b;border-bottom:1px solid #1f2a38}
  #top.show{display:flex;flex-wrap:wrap}
  input[type="text"]{padding:8px 10px;border:1px solid #39495e;background:#0b1118;color:var(--text);border-radius:8px}
  button{padding:10px 12px;border-radius:10px;border:1px solid #374151;background:#131a22;color:var(--text)}
  button:disabled{opacity:.6}
  #map{display:none;height:calc(100vh - 56px)}
  #map.show{display:block}

  /* beacon visuals */
  #beaconWrap{display:none;height:100vh;padding:22px;box-sizing:border-box;align-items:center;justify-content:center}
  #beaconWrap.show{display:flex}
  .beacon{width:min(86vw,520px);aspect-ratio:1/1;position:relative;background:radial-gradient(ellipse at 50% 45%,#0f151e 0%,#0b0e12 55%,#070a0d 100%);
          border-radius:50%;box-shadow:inset 0 0 40px rgba(0,0,0,.8),0 10px 40px rgba(0,0,0,.4);border:10px solid var(--rim);}
  .ring{position:absolute;inset:6%;border-radius:50%;border:2px solid #1a2230;box-shadow:inset 0 0 20px rgba(0,0,0,.6)}
  .r2{inset:16%}.r3{inset:26%}.r4{inset:36%}
  .eye{position:absolute;left:50%;top:42%;transform:translate(-50%,-50%);width:34%;aspect-ratio:1/1;border-radius:50%;
       background:radial-gradient(circle at 50% 45%,#ff6b6b 0%,#e31616 35%,#7a0d0d 75%,#2a0707 100%);
       box-shadow:0 0 40px rgba(255,60,60,.45),0 0 120px rgba(255,40,40,.25);animation:pulse 1.2s infinite;}
  @keyframes pulse{0%,70%{filter:brightness(1)}100%{filter:brightness(1.6)}}
  .tick{position:absolute;left:50%;top:42%;transform-origin:50% 50%;transform:translate(-50%,-50%) rotate(0deg);
        width:40%;height:2px;background:linear-gradient(90deg,rgba(255,60,60,0) 0%,rgba(255,60,60,0.6) 100%);
        border-radius:2px;filter:blur(.2px);opacity:.8;}
  .panel{position:absolute;left:50%;bottom:6%;transform:translateX(-50%);width:74%;padding:12px 14px;border-radius:12px;
         background:linear-gradient(180deg,#0f141b,#0b0f15);border:1px solid #1c2532;text-align:center;
         font-variant-numeric:tabular-nums;box-shadow:0 6px 24px rgba(0,0,0,.35),inset 0 0 30px rgba(0,0,0,.25)}
  .label{font-size:14px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
  .readout{margin-top:6px;font-size:28px}
  .tiny{font-size:12px;color:#8a93a1;margin-top:4px}
  .armWrap{position:absolute;inset:auto 0 16px 0;display:flex;justify-content:center}
  .arm{padding:14px 18px;font-size:16px;border-radius:999px;border:1px solid #3a4a5f;background:#101822;color:#dbe2ea}
  .arm.glow{box-shadow:0 0 16px rgba(255,60,60,.35);border-color:#9b2b2b;background:#1a0f12}
  .hidden{display:none!important}
</style>
</head>
<body>

<!-- ADMIN BAR -->
<div id="top">
  <label>Target: <input id="targetInput" type="text" placeholder="lat,lng or drop pin" style="width:220px"></label>
  <label>Label: <input id="labelInput" type="text" placeholder="Optional label" style="width:160px"></label>
  <button id="setFromMapBtn">Drop Pin</button>
  <button id="createLinkBtn">Create link & share</button>
  <button id="permissionBtn">Enable Compass</button>
  <button id="streetBtn">Street</button><button id="satBtn">Satellite</button>
</div>

<div id="map"></div>

<!-- PLAYER BEACON -->
<div id="beaconWrap">
  <div class="beacon">
    <div class="ring"></div><div class="ring r2"></div><div class="ring r3"></div><div class="ring r4"></div>
    <div class="eye" id="eye"></div>
    <div class="tick" id="tick"></div>
    <div class="panel">
      <div class="label" id="labelDisplay">Beacon Linked</div>
      <div class="readout" id="distanceDisplay">—</div>
      <div class="tiny" id="aux">Grant location, then tap ENABLE LOCATION.</div>
      <div class="armWrap" id="locWrap"><button class="arm" id="locBtn">ENABLE LOCATION</button></div>
      <div class="armWrap"><button class="arm glow" id="armBtn">ARM / START</button></div>
      <div id="geoMsg" style="margin-top:6px;font-size:12px;opacity:.8"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ============ Shared math & helpers ============ */
const toRad=v=>v*Math.PI/180;
function haversine(a,b,c,d){const R=6371000;const f1=toRad(a),f2=toRad(c);const d1=toRad(c-a),d2=toRad(d-b);
const x=Math.sin(d1/2)**2+Math.cos(f1)*Math.cos(f2)*Math.sin(d2/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}
function parseLatLng(s){if(!s)return null;const[p,q]=s.split(',').map(t=>t.trim());const lat=parseFloat(p),lng=parseFloat(q);
return Number.isFinite(lat)&&Number.isFinite(lng)?{lat,lng}:null;}
/* ============ Mode detection ============ */
const params=new URLSearchParams(location.search);
const isAdmin=params.get('admin')==='1';
const targetParam=(()=>{const lat=parseFloat(params.get('lat')),lng=parseFloat(params.get('lng')),label=params.get('label')||'';return Number.isFinite(lat)&&Number.isFinite(lng)?{lat,lng,label}:null;})();

/* ============ Admin setup ============ */
let map,osm,esriSat,targetMarker,userMarker,accuracyCircle,target=targetParam||null;
const topBar=document.getElementById('top'),mapEl=document.getElementById('map');
if(isAdmin){
  topBar.classList.add('show');mapEl.classList.add('show');
  osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19});
  esriSat=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19});
  map=L.map('map',{layers:[osm]}).setView([39,-98],4);
  streetBtn.onclick=()=>{if(map.hasLayer(esriSat))map.removeLayer(esriSat);osm.addTo(map)};
  satBtn.onclick=()=>{if(map.hasLayer(osm))map.removeLayer(osm);esriSat.addTo(map)};
  map.on('click',e=>{setTarget({lat:e.latlng.lat,lng:e.latlng.lng,label:labelInput.value||''});
                     targetInput.value=`${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`});
  createLinkBtn.onclick=async()=>{
    const parsed=parseLatLng(targetInput.value);if(parsed)setTarget({lat:parsed.lat,lng:parsed.lng,label:labelInput.value||''});
    if(!target){alert('Set a target first');return;}
    const url=new URL(location.href);url.search='';url.searchParams.set('lat',target.lat);url.searchParams.set('lng',target.lng);
    if(labelInput.value)url.searchParams.set('label',labelInput.value);const final=url.toString();
    await navigator.clipboard.writeText(final).catch(()=>prompt('Copy link',final));
    createLinkBtn.textContent='Copied!';setTimeout(()=>createLinkBtn.textContent='Create link & share',1500);
  };
}
function setTarget(t){target={lat:t.lat,lng:t.lng,label:t.label||''};if(isAdmin&&map){
  if(targetMarker)map.removeLayer(targetMarker);targetMarker=L.marker([t.lat,t.lng]).addTo(map).bindPopup(t.label||'Target');}}

/* ============ Player mode visuals & audio ============ */
const beaconWrap=document.getElementById('beaconWrap'),eyeEl=document.getElementById('eye'),
tickEl=document.getElementById('tick'),labelDisplay=document.getElementById('labelDisplay'),
distanceDisplay=document.getElementById('distanceDisplay'),aux=document.getElementById('aux'),
armBtn=document.getElementById('armBtn');
if(!isAdmin){beaconWrap.classList.add('show');if(targetParam)labelDisplay.textContent=targetParam.label||'Beacon Linked';}

let audioCtx=null,gainNode=null,beepTimer=null,sweepTimer=null,armed=false,lastPos=null;
function ensureAudio(){if(audioCtx)return;audioCtx=new (window.AudioContext||window.webkitAudioContext)();gainNode=audioCtx.createGain();
gainNode.connect(audioCtx.destination);gainNode.gain.value=0.0001;}
function playPip(freq=800,ms=90){if(!audioCtx)return;const now=audioCtx.currentTime;const o=audioCtx.createOscillator();
o.frequency.setValueAtTime(freq,now);o.type='sine';o.connect(gainNode);
gainNode.gain.setValueAtTime(0.0001,now);gainNode.gain.linearRampToValueAtTime(0.3,now+0.01);
gainNode.gain.exponentialRampToValueAtTime(0.0001,now+ms/1000);o.start(now);o.stop(now+ms/1000+.05);
navigator.vibrate?.(12);}
function cadence(d){if(d>800)return{interval:1400,freq:420};if(d>300)return{interval:900,freq:500};
if(d>120)return{interval:600,freq:620};if(d>40)return{interval:380,freq:760};if(d>15)return{interval:260,freq:900};
if(d>6)return{interval:180,freq:1020};return{interval:120,freq:1200};}
function scheduleBeep(interval,p){if(scheduleBeep.last===interval)return;scheduleBeep.last=interval;
clearInterval(beepTimer);playPip(p);beepTimer=setInterval(()=>playPip(p),Math.max(120,interval));}
function startSweep(rps){if(startSweep._rps===rps)return;startSweep._rps=rps;
cancelAnimationFrame(sweepTimer);let start=null;function step(t){if(!start)start=t;const e=(t-start)/1000;
tickEl.style.transform=`translate(-50%,-50%) rotate(${(e*rps*360)%360}deg)`;sweepTimer=requestAnimationFrame(step);}
sweepTimer=requestAnimationFrame(step);}
armBtn.onclick=async()=>{ensureAudio();await audioCtx.resume();armed=true;armBtn.classList.add('hidden');
aux.textContent='Tracking… beeps accelerate as you approach.';};

/* ============ Enhanced location handling ============ */
const locBtn=document.getElementById('locBtn'),locWrap=document.getElementById('locWrap'),geoMsg=document.getElementById('geoMsg');
function showMsg(t){geoMsg.textContent=t;}
function explain(e){if(!e)return'Unknown error';if(e.code===1)return'Permission denied — allow Location for this site (and Precise).';
if(e.code===2)return'Position unavailable — move outside or wait for GPS.';if(e.code===3)return'Timeout — retrying…';return e.message;}
function warnInsecure(){if(location.protocol!=='https:'&&location.hostname!=='localhost')
aux.textContent='⚠️ iOS requires HTTPS for location. Use an https:// URL (GitHub Pages / Netlify / ngrok).';}
warnInsecure();
function onGeoOK(pos){locWrap.classList.add('hidden');showMsg('Location active.');onPosition(pos);}
function onGeoErr(e){showMsg('Location: '+explain(e));locWrap.classList.remove('hidden');}
function requestOneShot(){if(!navigator.geolocation){showMsg('Geolocation not supported');return;}
navigator.geolocation.getCurrentPosition(onGeoOK,onGeoErr,{enableHighAccuracy:true,timeout:15000,maximumAge:0});}
if('geolocation'in navigator){navigator.geolocation.watchPosition(onGeoOK,onGeoErr,{enableHighAccuracy:true,timeout:15000,maximumAge:1000});}
locBtn.addEventListener('click',requestOneShot);
if(navigator.permissions?.query){navigator.permissions.query({name:'geolocation'}).then(s=>{
showMsg('Permission: '+s.state);s.onchange=()=>showMsg('Permission: '+s.state);}).catch(()=>{});}

/* ============ Position updates ============ */
function onPosition(pos){
  const lat=pos.coords.latitude,lng=pos.coords.longitude;lastPos={lat,lng};
  if(isAdmin&&map){if(userMarker)userMarker.setLatLng([lat,lng]);else userMarker=L.marker([lat,lng]).addTo(map).bindPopup('You');}
  if(!target||!beaconWrap.classList.contains('show'))return;
  const d=haversine(lat,lng,target.lat,target.lng);
  distanceDisplay.textContent=d<1000?`${Math.round(d)} m`:`${(d/1000).toFixed(2)} km`;
  const {interval,freq}=cadence(d);eyeEl.style.animationDuration=Math.max(0.3,interval/900)+'s';
  startSweep(Math.max(0.8,3000/interval));if(armed)scheduleBeep(interval,freq);
  if(d<=6){eyeEl.style.filter='brightness(2)';navigator.vibrate?.([20,60,20,60]);}
}
</script>
</body>
</html>
